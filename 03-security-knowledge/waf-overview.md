# WAF 基础与参考（简版）

目的：在平台外做短期缓解与流量侧防护的知识卡片，便于后续基于开源 WAF 搭建开源 Web 防护体系。

## 1. WAF 是什么

- 定义：位于客户端与 Web 应用之间的策略执行点，用规则识别并阻断恶意请求
- 作用：降低在修复上线前的暴露风险，尤其针对常见漏洞类别（SQLi/XSS/命令注入等）

## 2. 常见模式（择优）

- 负向模型（黑名单/签名匹配）：对外系统优先，上手快、误报相对较低
- 正向模型（白名单/允许列表）：面向受限的管理/内网系统，安全性强但维护成本高
- 混合模型：前台流量用负向，管理面叠加白名单；建议先走“监控/影子模式”评估再阻断

## 3. 识别与验证（运维侧提示）

- 识别线索：常见 HTTP 端口、特定 Cookie/Headers 指纹、Server 指纹、异常返回码
- 验证方法：使用“无害探测载荷”（低风险 XSS/SQLi 关键字、路径遍历符号等）做灰度验证
- 发布节奏：影子→灰度→全量，并设置回滚阈值；记录命中/误报/延迟指标

## 4. 在本平台中的定位

- 定位：仅作为应对措施；主线仍为代码修复、配置加固、流程防错与资产治理
- 展望：后期可基于开源 WAF（如 Nginx/OpenResty + 开源规则）构建可审计的开源防护体系

## 5. 参考资料

- Awesome-WAF（原理/模式/识别与测试；精选资料库）
  - https://github.com/0xInfection/Awesome-WAF

## 6. 开源 WAF 落地路线图

目标：以“最小干扰、可回滚、可审计”为原则，采用开源组件逐步建立可运营的 Web 防护体系，定位为“快速缓解 + 持续运营”，不替代源头修复与架构加固。

- 阶段一（0-1 个月）：最小可用与安全运营“接入”

  - 技术栈（示例）：Nginx/OpenResty 作为反向代理，先行接入自定义基础规则（URI 黑名单、关键参数限速、基础 Header 加固）
  - 策略模式：仅启用“监控/影子模式”（不阻断），对高风险入口（登录、交易）按路径/参数做 Allowlist，减少误报
  - 可观测性：接入日志到现有链路（Grafana/ELK），建立 3 个基础指标：命中数、误报率、端到端延迟开销
  - 运维基线：建立变更工单模板（需求/范围/风险/回滚），明确 SLO 与回滚阈值，梳理影子→灰度→全量流程
  - 快速缓解：对“已确认高危漏洞”启用临时规则（限速/参数校验/路径隔离），并绑定到修复计划与到期清理机制
- 阶段二（1-3 个月）：规则工程化与 CI/CD

  - 引入成熟规则集与引擎：规划 ModSecurity v3 + 开源规则集（如通用攻击类规则）、或 OpenResty/Lua 规则框架分层管理
  - 策略分层：基础通用规则（全局）+ 业务专项规则（按系统/租户）+ 例外清单（到期清理）
  - 规则仓库化：Git 管理规则与变更脚本，代码评审 + 自动化测试（误报回归样例、性能基线）
  - 发布策略：灰度发布（按流量/地域/用户群），对关键系统设置独立节流与回滚开关
  - 数据闭环：WAF 命中事件与平台（DefectDojo）打通，自动生成“WAF 规则变更/验证”任务并追踪有效性
  - 安全能力增强：接入 IP 信誉/地理策略、Bot 基础识别、认证面更严格的 Allowlist
- 阶段三（3-6 个月+）：规模化运营与协同防御

  - 多集群/多地域：集中策略管理与分发；策略生效与回滚可视化
  - IaC 化：将 WAF 基建（网关、规则、日志管道）纳入 Terraform/Ansible，配合 GitOps 落地
  - 智能化与联动：基于评估结果与攻击画像生成策略建议，联动后端输入校验/限流、RASP 与 L7 DDoS
  - SRE 化运营：误报预算与错误预算（Error Budget）管理；防护对业务可用性的影响纳入目标
  - 红蓝对抗与常态化评估：持续演练与回归测试，确保策略不过期、不过度拦截
- 可交付物清单（分阶段沉淀）

  - 规则仓库结构与命名规范、评审流程、例外/到期策略
  - 变更工单与回滚预案模板、灰度发布 SOP
  - 监控仪表盘（命中/误报/延迟/业务指标）、告警阈值与周报模板
  - 回归测试套件（误报样例、常见有效载荷、性能基准）、流量回放脚本
- 风险与回滚策略

  - 始终先影子后阻断；关键变更走灰度与一键回滚
  - 关键系统优先“白名单 + 限速”，降级为记录与告警
  - 明确“Fail-Open/Fail-Closed”策略：业务关键路径优先 Fail-Open 并伴随实时告警与人工介入
- 与平台的关系

  - WAF 事件与评估平台打通：高命中但未阻断的事件转换为整改任务；长期依赖“源头修复 + 架构加固”
  - 依赖持续集成：将新发现漏洞类型映射为规则候选，形成“发现→缓解→修复→回归”的闭环